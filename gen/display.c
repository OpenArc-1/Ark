/**
 * Display Manager for Ark - 480p framebuffer output
 * 
 * Manages text rendering on framebuffer with proper scrolling,
 * cursor management, and kernel message buffering.
 */

#include "ark/types.h"
#include "ark/fb.h"

/* Display state */
static ark_fb_info_t display_fb;
static u32 display_x = 0;
static u32 display_y = 0;
static u32 display_initialized = 0;

/* Font dimensions (8x8 pixels per character) */
#define CHAR_WIDTH  8
#define CHAR_HEIGHT 8

/* Calculate grid dimensions */
static u32 max_cols = 0;
static u32 max_rows = 0;

/* Color constants (ARGB) */
#define COLOR_BLACK     0x00000000
#define COLOR_WHITE     0xFFFFFFFF
#define COLOR_GRAY      0xFF808080

/* Simple 8x8 bitmap font for ASCII printable characters */
static const u8 font_8x8[256][8] = {
    [' ']  = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
    ['0']  = {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C},
    ['1']  = {0x08, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1C},
    ['2']  = {0x3C, 0x42, 0x02, 0x04, 0x08, 0x10, 0x20, 0x7E},
    ['3']  = {0x3C, 0x42, 0x02, 0x1C, 0x02, 0x42, 0x42, 0x3C},
    ['4']  = {0x04, 0x0C, 0x14, 0x24, 0x7E, 0x04, 0x04, 0x04},
    ['5']  = {0x7E, 0x40, 0x40, 0x7C, 0x02, 0x02, 0x42, 0x3C},
    ['6']  = {0x1C, 0x20, 0x40, 0x7C, 0x42, 0x42, 0x42, 0x3C},
    ['7']  = {0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x10, 0x10},
    ['8']  = {0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x42, 0x3C},
    ['9']  = {0x3C, 0x42, 0x42, 0x42, 0x3E, 0x02, 0x04, 0x38},
    ['a']  = {0x00, 0x00, 0x3C, 0x02, 0x3E, 0x42, 0x42, 0x3E},
    ['b']  = {0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x62, 0x5C},
    ['c']  = {0x00, 0x00, 0x3C, 0x40, 0x40, 0x40, 0x42, 0x3C},
    ['d']  = {0x02, 0x02, 0x3A, 0x46, 0x42, 0x42, 0x46, 0x3A},
    ['e']  = {0x00, 0x00, 0x3C, 0x42, 0x7E, 0x40, 0x42, 0x3C},
    ['f']  = {0x0C, 0x12, 0x10, 0x3C, 0x10, 0x10, 0x10, 0x10},
    ['g']  = {0x00, 0x00, 0x3A, 0x46, 0x42, 0x3A, 0x02, 0x3C},
    ['h']  = {0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42},
    ['i']  = {0x08, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08},
    ['j']  = {0x04, 0x00, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38},
    ['k']  = {0x40, 0x40, 0x42, 0x44, 0x48, 0x54, 0x62, 0x42},
    ['l']  = {0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08},
    ['m']  = {0x00, 0x00, 0x76, 0xFB, 0x89, 0x89, 0x89, 0x89},
    ['n']  = {0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42},
    ['o']  = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C},
    ['p']  = {0x00, 0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40},
    ['q']  = {0x00, 0x00, 0x3C, 0x42, 0x42, 0x3C, 0x02, 0x03},
    ['r']  = {0x00, 0x00, 0x5C, 0x62, 0x40, 0x40, 0x40, 0x40},
    ['s']  = {0x00, 0x00, 0x3C, 0x40, 0x3C, 0x02, 0x3C, 0x00},
    ['t']  = {0x10, 0x10, 0x3C, 0x10, 0x10, 0x10, 0x12, 0x0C},
    ['u']  = {0x00, 0x00, 0x42, 0x42, 0x42, 0x42, 0x46, 0x3A},
    ['v']  = {0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18},
    ['w']  = {0x00, 0x00, 0x89, 0x89, 0x89, 0x55, 0x55, 0x22},
    ['x']  = {0x00, 0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42},
    ['y']  = {0x00, 0x00, 0x42, 0x42, 0x42, 0x3E, 0x02, 0x3C},
    ['z']  = {0x00, 0x00, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x7E},
    ['A']  = {0x3C, 0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42},
    ['B']  = {0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x42, 0x7C},
    ['C']  = {0x3C, 0x42, 0x40, 0x40, 0x40, 0x40, 0x42, 0x3C},
    ['D']  = {0x78, 0x44, 0x42, 0x42, 0x42, 0x42, 0x44, 0x78},
    ['E']  = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x7E},
    ['F']  = {0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x40},
    ['G']  = {0x3C, 0x42, 0x40, 0x40, 0x4E, 0x42, 0x42, 0x3E},
    ['H']  = {0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x42},
    ['I']  = {0x1C, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1C},
    ['J']  = {0x0E, 0x04, 0x04, 0x04, 0x04, 0x44, 0x44, 0x38},
    ['K']  = {0x42, 0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44},
    ['L']  = {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E},
    ['M']  = {0x82, 0xC6, 0xAA, 0xAA, 0x92, 0x92, 0x82, 0x82},
    ['N']  = {0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x42},
    ['O']  = {0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C},
    ['P']  = {0x7C, 0x42, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40},
    ['Q']  = {0x3C, 0x42, 0x42, 0x42, 0x42, 0x46, 0x44, 0x3A},
    ['R']  = {0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0x42},
    ['S']  = {0x3C, 0x42, 0x40, 0x3C, 0x02, 0x42, 0x42, 0x3C},
    ['T']  = {0x7E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08},
    ['U']  = {0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C},
    ['V']  = {0x42, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18, 0x18},
    ['W']  = {0x82, 0x82, 0x92, 0xAA, 0xAA, 0xC6, 0x82, 0x82},
    ['X']  = {0x42, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x42},
    ['Y']  = {0x42, 0x42, 0x24, 0x24, 0x18, 0x08, 0x08, 0x08},
    ['Z']  = {0x7E, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7E},
    ['.']  = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18},
    [':']  = {0x00, 0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00},
    ['-']  = {0x00, 0x00, 0x00, 0x3C, 0x00, 0x00, 0x00, 0x00},
    ['/']  = {0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00},
    ['[']  = {0x1C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1C},
    [']']  = {0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38},
    ['(']  = {0x0C, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x0C},
    [')']  = {0x30, 0x08, 0x04, 0x04, 0x04, 0x04, 0x08, 0x30},
    ['_']  = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE},
    ['+']  = {0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00, 0x00},
    ['=']  = {0x00, 0x00, 0x3C, 0x00, 0x3C, 0x00, 0x00, 0x00},
    ['*']  = {0x00, 0x08, 0x3E, 0x1C, 0x3E, 0x08, 0x00, 0x00},
    ['!']  = {0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x08, 0x00},
    ['?']  = {0x3C, 0x42, 0x02, 0x04, 0x08, 0x00, 0x08, 0x00},
    [',']  = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10},
    ['#']  = {0x24, 0x24, 0x7E, 0x24, 0x7E, 0x24, 0x24, 0x00},
    ['@']  = {0x3C, 0x42, 0x49, 0x55, 0x59, 0x4E, 0x40, 0x3C},
    ['\\'] = {0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x01},
    ['%']  = {0x62, 0x92, 0x94, 0x68, 0x16, 0x29, 0x49, 0x86},
};

static inline void fb_write_pixel(u32 x, u32 y, u32 argb) {
    if (x >= display_fb.width || y >= display_fb.height || !display_fb.addr) {
        return;
    }
    u32 *base = (u32 *)display_fb.addr;
    /* Calculate row offset considering pitch (in bytes) */
    u32 row_offset = y * (display_fb.pitch / sizeof(u32));
    base[row_offset + x] = argb;
}


/**
 * Draw a character using bitmap font
 */
static void display_draw_char(u32 col, u32 row, char c) {
    u32 px = col * CHAR_WIDTH;
    u32 py = row * CHAR_HEIGHT;

    if (px + CHAR_WIDTH > display_fb.width || py + CHAR_HEIGHT > display_fb.height) {
        return;
    }

    /* Get bitmap for character */
    const u8 *bitmap = font_8x8[(u8)c];
    u32 glyph_color = COLOR_WHITE;

    /* Draw 8x8 character using bitmap with proper bit extraction */
    for (u32 y = 0; y < CHAR_HEIGHT && py + y < display_fb.height; y++) {
        u8 row_bits = bitmap[y];
        
        for (u32 x = 0; x < CHAR_WIDTH && px + x < display_fb.width; x++) {
            /* Check if bit is set in bitmap (MSB first, left to right) */
            u8 bit = (row_bits >> (7 - x)) & 1;
            
            if (bit) {
                fb_write_pixel(px + x, py + y, glyph_color);
            } else {
                fb_write_pixel(px + x, py + y, COLOR_BLACK);
            }
        }
    }
}

/**
 * Scroll the display up by one character row
 */
static void display_scroll(void) {
    if (!display_initialized || !display_fb.addr) return;

    u8 *base = display_fb.addr;

    /* Move all content up by CHAR_HEIGHT pixels */
    for (u32 y = 0; y < display_fb.height - CHAR_HEIGHT; y++) {
        u8 *dst = base + y * display_fb.pitch;
        u8 *src = base + (y + CHAR_HEIGHT) * display_fb.pitch;
        
        for (u32 i = 0; i < display_fb.pitch; i++) {
            dst[i] = src[i];
        }
    }

    /* Clear bottom row */
    for (u32 y = display_fb.height - CHAR_HEIGHT; y < display_fb.height; y++) {
        u32 *row = (u32 *)(base + y * display_fb.pitch);
        u32 pixels_per_line = display_fb.pitch / 4;
        
        for (u32 x = 0; x < pixels_per_line; x++) {
            row[x] = COLOR_BLACK;
        }
    }

    if (display_y > 0) {
        display_y--;
    }
}

/**
 * Initialize the display manager
 */
void display_init(const ark_fb_info_t *fb_info) {
    if (!fb_info || !fb_info->addr) {
        display_initialized = 0;
        return;
    }

    display_fb = *fb_info;
    display_x = 0;
    display_y = 0;

    /* Calculate grid dimensions */
    max_cols = display_fb.width / CHAR_WIDTH;
    max_rows = display_fb.height / CHAR_HEIGHT;

    display_initialized = 1;

    /* Clear screen */
    display_clear();
}

/**
 * Clear the display
 */
void display_clear(void) {
    if (!display_initialized) {
        return;  /* Cannot clear if not initialized */
    }
    
    if (!display_fb.addr) {
        return;  /* No framebuffer address */
    }

    u32 *base = (u32 *)display_fb.addr;
    u32 pixels_per_line = display_fb.pitch / sizeof(u32);
    u32 total_rows = display_fb.height;

    for (u32 y = 0; y < total_rows; y++) {
        u32 *row = base + (y * pixels_per_line);
        for (u32 x = 0; x < pixels_per_line; x++) {
            row[x] = COLOR_BLACK;
        }
    }

    display_x = 0;
    display_y = 0;
}

/**
 * Put a single character on the display
 */
void display_putc(char c) {
    /* If not initialized, still try to write if we have framebuffer info */
    if (!display_initialized) {
        return;  /* Need to initialize first */
    }
    
    if (!display_fb.addr || max_cols == 0 || max_rows == 0) {
        return;  /* No valid framebuffer */
    }

    if (c == '\n') {
        display_x = 0;
        display_y++;
    } else if (c == '\r') {
        display_x = 0;
    } else if (c == '\t') {
        display_x = (display_x + 4) & ~3U;
        return;
    } else if (c == '\b') {
        if (display_x > 0) {
            display_x--;
            display_draw_char(display_x, display_y, ' ');
        }
        return;
    } else {
        /* Draw the character */
        display_draw_char(display_x, display_y, c);
        display_x++;
    }

    /* Handle line wrapping */
    if (display_x >= max_cols) {
        display_x = 0;
        display_y++;
    }

    /* Handle vertical scrolling */
    while (display_y >= max_rows) {
        display_scroll();
    }
}

/**
 * Put a string on the display
 */
void display_puts(const char *s) {
    if (!s) return;
    while (*s) {
        display_putc(*s++);
    }
}

/**
 * Get display dimensions
 */
u32 display_get_width(void) {
    return max_cols;
}

u32 display_get_height(void) {
    return max_rows;
}

u32 display_is_initialized(void) {
    return display_initialized;
}

/**
 * Get framebuffer address (exported to userspace)
 */
u32 *display_get_framebuffer(void) {
    if (!display_initialized || !display_fb.addr) {
        return NULL;
    }
    return (u32 *)display_fb.addr;
}

